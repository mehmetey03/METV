name: popcorrn GÃ¼ncelleme

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'

concurrency:
  group: popcorrn-guncelleme-${{ github.ref }}
  cancel-in-progress: true

jobs:
  fetch-and-commit:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      # 1. Repo'yu klonla
      - name: Depoyu Klonla
        uses: actions/checkout@v4

      # 2. Playlist'i indir (GÃœVENLÄ° CURL)
      - name: Playlist'i Ã‡ek (curl)
        run: |
          echo "ğŸ“¥ Playlist indiriliyor..."

          HTTP_CODE=$(curl -L \
            --connect-timeout 15 \
            --max-time 60 \
            -A "Mozilla/5.0 (Windows NT 10.0; Win64; x64)" \
            -w "%{http_code}" \
            -o indirildi_playlist.m3u \
            "http://ns3051909.ip-137-74-92.eu:25461/get.php?username=900EB311156D&password=PopcornTV&type=m3u_plus&output=m3u"
          )

          echo "ğŸŒ HTTP CODE: $HTTP_CODE"

          # BaÅŸarÄ±sÄ±zsa dosyayÄ± sil
          if [ "$HTTP_CODE" != "200" ]; then
            echo "âŒ Playlist indirilemedi (HTTP $HTTP_CODE)"
            rm -f indirildi_playlist.m3u
            exit 0
          fi

          # Dosya boÅŸsa iptal
          if [ ! -s indirildi_playlist.m3u ]; then
            echo "âŒ Dosya boÅŸ, commit atlanÄ±yor."
            rm -f indirildi_playlist.m3u
            exit 0
          fi

          echo "âœ… Playlist baÅŸarÄ±yla indirildi."

      # 3. Commit + Push
      - name: DeÄŸiÅŸiklikleri Depoya GÃ¶nder
        run: |
          if [ ! -f indirildi_playlist.m3u ]; then
            echo "â„¹ï¸ GÃ¼ncellenecek dosya yok."
            exit 0
          fi

          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add indirildi_playlist.m3u

          # DeÄŸiÅŸiklik yoksa commit atma
          if git diff --cached --quiet; then
            echo "â„¹ï¸ DeÄŸiÅŸiklik yok, commit atlanÄ±yor."
            exit 0
          fi

          git commit -m "Otomatik GÃ¼ncelleme: M3U playlist yenilendi"

          # Ã‡AKIÅMASIZ PUSH
          git pull --rebase origin main
          git push origin main

          echo "ğŸš€ GÃ¼ncelleme baÅŸarÄ±yla gÃ¶nderildi."
